Menu="Utilities"
Type="xmenu"
Title="TmuxAI"
Icon="tmuxai.png"
Tag="terminal"
Markdown="false"
---
<?php
require_once '/usr/local/emhttp/webGui/include/Helpers.php';

$config_file = '/boot/config/plugins/tmuxai/config/config.yaml';
$config_dir = '/boot/config/plugins/tmuxai/config';

// Ensure config directory exists
if (!is_dir($config_dir)) {
    mkdir($config_dir, 0755, true);
}

// Note: Save handling is now done via AJAX (see JavaScript section below)

// Read current config
$config_content = '';
if (file_exists($config_file)) {
    $config_content = file_get_contents($config_file);
} else {
    // Use default sample config
    $config_content = <<<'EOT'
# TmuxAI Example Configuration
# This is a sample configuration file for tmuxai
# 
# SECURITY WARNING: This file may contain sensitive API keys!
# - Do NOT commit this file to version control with real API keys
# - Keep your API keys secure and private
# - Consider using environment variables for production use
#
# IMPORTANT: You MUST customize this configuration before use!
# Replace "YOUR_API_KEY_HERE" with your actual API keys

# Example configuration with OpenRouter models:
# Uncomment and customize the models you want to use

# models:
#   glm-4.7:
#     provider: "openrouter"
#     model: "z-ai/glm-4.7"
#     api_key: "YOUR_API_KEY_HERE"
#   kimi-k2.5:
#     provider: "openrouter"
#     model: "moonshotai/kimi-k2.5"
#     api_key: "YOUR_API_KEY_HERE"

# To use this configuration:
# 1. Uncomment the models section above
# 2. Replace YOUR_API_KEY_HERE with your actual OpenRouter API key
# 3. You can add more models as needed
# 4. For more information, visit https://tmuxai.dev
EOT;
}

$version_output = '';
if (file_exists('/usr/local/bin/tmuxai')) {
    exec('/usr/local/bin/tmuxai --version 2>&1', $version_lines);
    $version_output = implode("\n", $version_lines);
}
?>

<style>
.tmuxai-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background: #1c1c1c;
    color: #e0e0e0;
}

.tmuxai-section {
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 5px;
    padding: 20px;
    margin-bottom: 20px;
}

.tmuxai-section h2 {
    margin-top: 0;
    color: #e0e0e0;
    font-size: 18px;
    border-bottom: 2px solid #ff8c00;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.tmuxai-section h3 {
    color: #d0d0d0;
}

.tmuxai-section p,
.tmuxai-section ol,
.tmuxai-section ul,
.tmuxai-section li {
    color: #c0c0c0;
}

.tmuxai-section a {
    color: #4a9eff;
}

.tmuxai-section a:hover {
    color: #6ab0ff;
}

.tmuxai-section code {
    background: #1a1a1a;
    color: #ff8c00;
    padding: 2px 6px;
    border-radius: 3px;
}

.config-editor {
    width: 100%;
    min-height: 400px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    padding: 10px;
    border: 1px solid #3a3a3a;
    border-radius: 3px;
    background: #1a1a1a;
    color: #e0e0e0;
}

.button-group {
    margin-top: 15px;
}

.btn {
    padding: 8px 20px;
    margin-right: 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
}

.btn-primary {
    background: #ff8c00;
    color: white;
}

.btn-primary:hover {
    background: #e67e00;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.info-box {
    background: #2a3a4a;
    border-left: 4px solid #4a9eff;
    padding: 12px;
    margin: 15px 0;
    color: #d0d0d0;
}

.success-message {
    background: #1a4d2e;
    border: 1px solid #2d6a4f;
    color: #90ee90;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.error-message {
    background: #4d1a1a;
    border: 1px solid #6a2d2d;
    color: #ff6b6b;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.version-info {
    font-family: monospace;
    background: #1a1a1a;
    color: #c0c0c0;
    padding: 10px;
    border-radius: 3px;
    margin: 10px 0;
}
</style>

<div class="tmuxai-container">
    <div class="tmuxai-section">
        <h2>TmuxAI Configuration</h2>
        
        <div class="info-box">
            <strong>Configuration File:</strong> <?= htmlspecialchars($config_file) ?><br>
            <strong>Info:</strong> Edit your tmuxai configuration below. This file persists across Unraid reboots.
        </div>

        <?php if ($version_output): ?>
        <div class="version-info">
            <strong>Installed Version:</strong><br>
            <?= htmlspecialchars($version_output) ?>
        </div>
        <?php endif; ?>

        <form id="tmuxai-config-form" method="POST">
            <textarea id="config_content" name="config_content" class="config-editor" spellcheck="false"><?= htmlspecialchars($config_content) ?></textarea>
            
            <div class="button-group">
                <button type="button" id="btnSave" class="btn btn-primary">Save Configuration</button>
                <button type="button" class="btn btn-secondary" onclick="location.reload();">Reload</button>
            </div>
        </form>
    </div>

    <div class="tmuxai-section">
        <h2>About TmuxAI</h2>
        <p>
            TmuxAI brings powerful AI assistance directly into your tmux terminal sessions. 
            Integrate with ChatGPT, Claude, Gemini, and other AI models without leaving your terminal.
        </p>
        
        <h3>Quick Start:</h3>
        <ol>
            <li>Configure your AI provider API keys in the configuration above</li>
            <li>Start tmux: <code>tmux</code></li>
            <li>Press <code>prefix + C</code> (capital C) to ask AI a question</li>
            <li>Or use the command: <code>tmuxai ask "your question"</code></li>
        </ol>

        <h3>Supported Providers:</h3>
        <ul>
            <li>OpenAI (ChatGPT)</li>
            <li>Anthropic (Claude)</li>
            <li>Google (Gemini)</li>
            <li>OpenRouter</li>
            <li>Other OpenAI-compatible APIs</li>
        </ul>

        <h3>Resources:</h3>
        <ul>
            <li><a href="https://tmuxai.dev" target="_blank">TmuxAI Documentation</a></li>
            <li><a href="https://github.com/alvinunreal/tmuxai" target="_blank">TmuxAI on GitHub</a></li>
            <li><a href="https://github.com/zeddius1983/unraid-tmuxai" target="_blank">Plugin Repository</a></li>
        </ul>
    </div>
</div>

<script type="text/javascript">
$(function() {
    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    $('#btnSave').click(function() {
        var configContent = $('#config_content').val();
        
        $.post('/plugins/tmuxai/include/tmuxai_save.php', {
            config_content: configContent
        }, function(data) {
            var Title = 'Configuration ';

            if(data.success && data.success.response) {
                swal({
                    title: Title + 'Saved',
                    text: 'The configuration was saved successfully:<br><br><span style="font-weight:bold;">' + escapeHtml(data.success.response) + '</span>',
                    timer: 2000,
                    showConfirmButton: false,
                    html: true,
                    type: 'success'
                }, function() {
                    // Configuration saved, stay on the page
                });
            } else if(data.error && data.error.response) {
                swal({
                    title: Title + 'Error',
                    text: 'There was an error saving the configuration:<br><br><span style="font-weight:bold;">' + escapeHtml(data.error.response) + '</span>',
                    html: true,
                    type: 'error'
                });
            } else {
                swal({
                    title: Title + 'Error',
                    text: 'There was an unknown error saving the configuration.',
                    html: true,
                    type: 'error'
                });
            }
        }, 'json').fail(function() {
            swal({
                title: 'Configuration Error',
                text: 'Failed to communicate with the server. Please try again.',
                html: true,
                type: 'error'
            });
        });
    });
});
</script>

